rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /guestbook/{doc} {
      allow read: if true;

      allow create: if request.auth != null
        && request.resource.data.keys().hasOnly(['uid','name','text','createdAt'])
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.name is string
        && request.resource.data.text is string
        && request.resource.data.name.size() >= 1
        && request.resource.data.name.size() <= 20
        && request.resource.data.text.size() >= 1
        && request.resource.data.text.size() <= 300;

      // ✅ 작성자(uid)만 수정 가능 + uid/createdAt은 변경 불가
      allow update: if request.auth != null
        && resource.data.uid == request.auth.uid
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.keys().hasOnly(['uid','name','text','createdAt'])
        && request.resource.data.name is string
        && request.resource.data.text is string
        && request.resource.data.name.size() >= 1
        && request.resource.data.name.size() <= 20
        && request.resource.data.text.size() >= 1
        && request.resource.data.text.size() <= 300;

      allow delete: if false;
    }

    match /visitors/{date} {
      allow read: if true;
      allow write: if true;
    }
  }
}
